version 16

************************************************************************
* PART 0: TABLE OF CONTENTS
************************************************************************
*** start log 
*capture log close
*log using "path/do-filename.log", replace

* OccupationalRisk_PLFS.do

* Project: Occupational Risk
* Author: Ashwin Mb, ashwin.mb@berkeley.edu
* Date Created: June 15 2020
* Last modified: Aug 19 2020
* Data In: PLFS_long4.dta
* Data Out: [What data does this do-file produce?]
* Purpose of do-file: 
/*
	Outline
	Part 1: COMPARING AGGREGATE STATS WITH THE REPORT
	Part 2: 
	Part 3: 
*/
************************************************************************
* PART 0: SETTING UP ALL THE VARIABLES & LABELS
************************************************************************
set more off 

* Setting file path
global DataDir "/Users/ashwinmb/Desktop/IDFC/Data_Team/Occupational Risk/PLFS/data/"

* Opening the main input file - PLFS dataset
use "$DataDir/dtafiles/PLFS_long4.dta", clear

* Labelling the sector 
label variable sector "Rural = 1; Urban = 2"

** Tagging Occupation by main division 
gen p_occucode_nco_main = . 
replace p_occucode_nco_main = p_occucode_nco/100
replace p_occucode_nco_main = round(p_occucode_nco_main,1)

* Naming data labels
label variable p_occucode_nco_main "Occupation Division"

label define division 1	"Legislators, Senior Officials and Managers" ///
	2 "Professionals" 3 "Technicians and Associate Professionals" 4 "Clerks" ///
	5 "Service Workers and Shop & Market Sales Workers" ///
	6 "Skilled Agricultural and Fishery Workers" ///
	7 "Craft and related Trades Workers" ///
	8 "Plant and Machine Operators and Assemblers" 9 "Elementary Occupations"

label values p_occucode_nco_main division

/* Tagging rural and urban workplace -- rural and urban workplaces are named 
	based on p_workloc (rural, urban). For workloc = others, tagged based on the 
	region (where the individual resides) */

gen region_workplace = . 
replace region_workplace = 1 if p_workloc <=19 
replace region_workplace = 2 if p_workloc > 19 & p_workloc <=29 
replace region_workplace = sector if p_workloc == 99 

label variable region_workplace "Workplace location: Rural location = 1; Urban Location = 2"

************************************************************************
* PART 1: COMPARING AGGREGATE STATS WITH THE REPORT
************************************************************************
** We compare the aggregate statistics for key metrics with the PLFS 17-18 report 
* Link to the PLFS 2017-18 report: http://www.mospi.gov.in/sites/default/files/publication_reports/Annual%20Report%2C%20PLFS%202017-18_31052019.pdf

** Reading the survey data
* primary sampling unit (PSU) = 1st stage - state; 2nd - region; 3rd - district; 4th - fsu
* sampling weights for households = hmult 
* sample weights for individuals = pmult

** Initializing svy command
svyset state [pweight=hmult], vce(linearized) singleunit(missing) || region || district || fsu || hhid
svydescribe

* Perc of population in urban and rural regions [Comment: same as the report]
svy: tab sector if v == 1 // rural = 70.69; urban = 29.31

* Sex ratio by region [Comment: same as the report]
svy: tab sex if sector == 1 // 51.22% male which is 952 per 1000 males
svy: tab sex if sector == 2 & v == 1  // 50.89% which is 965 per 1000 males

* Literacy rates by region [Comment: same as the report]
gen literate = 1 if gedu !=1 
replace literate = 0 if literate == . 
svy: tab literate if sector == 1 & age >= 7 // 72.75 vs 72.8 in report

** Labour Force 
* Comparing WPR according to usual status (ps + ss) by region, sex [Comment: within 0.5%]
* WPR = worker population ratio = % of people employed = number employed/ total population
gen working_ps = 1 if p_statuscode <=72
replace working_ps = 0 if working == . 
svy: tab working_ps if sex == 1 & sector == 1 //rural, male
svy: tab working_ps if sex == 2 & sector == 1 //rural, female
svy: tab working_ps if sex == 1 & sector == 2 & v == 1 //urban, male
svy: tab working_ps if sex == 2 & sector == 2 & v == 1 //urban, female

* Comparing WPR according to cws by region, sex [Comment: within 0.5%]
* WPR = worker population ratio = % of people employed = number employed/ total population
gen working_cws = 1 if cws <=72
replace  working_cws = 0 if working_cws == . 
svy: tab  working_cws if sex == 1 & sector == 1 //rural, male
svy: tab  working_cws if sex == 2 & sector == 1 //rural, female
svy: tab  working_cws if sex == 1 & sector == 2 & v == 1 //urban, male
svy: tab  working_cws if sex == 2 & sector == 2 & v == 1 //urban, female

* Comparing LFPR according to usual status (ps + ss) by region, sex [Comment: within 0.5%]
* Labour Force participation rate = LFPR = no. employed + no. unemployed / total
gen lfpr_ps = 1 if p_statuscode <=82
replace lfpr_ps = 0 if lfpr_ps == . 
svy: tab  lfpr_ps if sex == 1 & sector == 1 //rural, male
svy: tab  lfpr_ps if sex == 2 & sector == 1 //rural, female
svy: tab  lfpr_ps if sex == 1 & sector == 2 & v == 1 //urban, male
svy: tab  lfpr_ps if sex == 2 & sector == 2 & v == 1 //urban, female

* Comparing LFPR according to usual status (ps + ss) for randomly choosen two states by region, sex [Comment: within 0.5%]
* Labour Force participation rate = LFPR = no. employed + no. unemployed / total
svy: tab lfpr_ps if sex == 1 & sector == 1 & state == 28 // for Andhra Pradesh
svy: tab lfpr_ps if sex == 2 & sector == 2 & v == 1 & state == 31 // for Lakshwadeep

* Comparing occupational level data based on NCO-2004 [Comment: same as the report]
svy: tab p_occucode_nco if sex == 1 & sector == 1 & v == 1, nolabel // rural, male, 
svy: tab p_occucode_nco, nolabel 

************************************************************************
* PART 2: DATA ANALYSIS AT OCCUPATION LEVEL
************************************************************************
** Setting up svy at individual level 
svyset state [pweight=pmult], vce(linearized) singleunit(missing) || region || district || fsu || hhid

* Calculating share of different social benefits for each occupation
svy: tab p_occucode_nco p_socsec if p_occucode_nco < 500, row nolabel
svy: tab p_occucode_nco p_socsec if p_occucode_nco >= 500, row nolabel

* Calculating share of different contract-types for each occupation
svy: tab p_occucode_nco p_jobcontract, row nolabel 

* Calculating whether workers are eligible for paid-leaves for each occupation
svy: tab p_occucode_nco p_paidleave, row nolabel 

************************************************************************
* PART 3: DATA ANALYSIS FOR OCCUPATIONS ACROSS REGIONS (URBAN/ RURAL)
************************************************************************

* Saving data into excel
ssc install estout

* Setting up svy at individual level 
svyset state [pweight=pmult], vce(linearized) singleunit(missing) || region || district || fsu || hhid

*** FIGURE 1 ***
** Calculating share of workers in different occupational division for rural and urban sector separately 
svy: tab p_occucode_nco_main if sector == 1
svy: tab p_occucode_nco_main if sector == 2

*** FIGURE 2 & 3 ***


* Calculating share of different social benefits for each occupation for urban and rural sector
* Saving the output into csv file 
* Splitting the data into two parts - p_occucode_nco < 500 & p_occucode_nco >= 500
foreach i in 1 2{
estpost svy: tab p_occucode_nco p_socsec if region_workplace == `i' & v == 1 & p_occucode_nco < 500, row nolabel
esttab . using "$DataDir/csvfiles/PLFS_SocialBenefits_1_raw.csv", b(2) se(2) nostar unstack plain mtitle(`e(colvar)') append 
}

foreach i in 1 2{
estpost svy: tab p_occucode_nco p_socsec if region_workplace == `i' & v == 1 & p_occucode_nco >= 500, row nolabel
esttab . using "$DataDir/csvfiles/PLFS_SocialBenefits_1_raw.csv", b(2) se(2) nostar unstack plain mtitle(`e(colvar)') append 
}

* Calculating share of workers in different contract-types for each occupation for urban and rural sector
* Saving the output into csv file 
foreach i in 1 2{
estpost svy: tab p_occucode_nco p_jobcontract if region_workplace == `i' & v == 1, row nolabel
esttab . using "$DataDir/csvfiles/PLFS_ContractType_raw.csv", b(2) se(2) nostar unstack plain mtitle(`e(colvar)') append 
}

* Calculating whether workers are eligible for paid-leaves for each occupation for urban and rural sector
* Saving the output into csv file 
foreach i in 1 2{
estpost svy: tab p_occucode_nco p_paidleave if region_workplace == `i' & v == 1, row nolabel
esttab . using "$DataDir/csvfiles/PLFS_PaidLeaves_raw.csv", b(2) se(2) nostar unstack plain mtitle(`e(colvar)') append 
}


************************************************************************
* APPENDIX
************************************************************************

* Calculating share of workers in each occupation for rural sector <Not used in the analysis>
forval i = 1/10{
display `i'
estpost svy: tab p_occucode_nco p_workloc if p_occucode_nco_main == `i' & region_workplace == 1 , row nolabel // rural region, 
esttab . using "$DataDir/csvfiles/PLFS_workloc_raw.csv", b(2) se(2) nostar unstack plain mtitle(`e(colvar)') append 
}

* Calculating share of workers in each occupation for urban sector <Not used in the analysis>
forval i = 1/10{
display `i'
estpost svy: tab p_occucode_nco p_workloc if p_occucode_nco_main == `i' & region_workplace == 2 & v == 1, row nolabel // rural region, 
esttab . using "$DataDir/csvfiles/PLFS_workloc_raw.csv", b(2) se(2) nostar unstack plain mtitle(`e(colvar)') append 
}


